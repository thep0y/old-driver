# PDF 老司机

老司机开的是最难的车。

## 简介

本项目可视化部分使用 tauri + React 开发，PDF 处理部分使用国人开发的 low-level 库 lopdf，因为是 low-level，对 PDF 的处理都是低层级的、未经封装的代码，而我对 PDF 了解不深，所以非常欢迎对 PDF 有了解的人提交 PR 来改进代码中的不足之处。

## 安装

当前未提供全平台安装包，但部分平台已编译，为了提高国内用户下载速度，暂不在 release 中上传，改用国内网盘：https://www.123pan.com/s/Q61bVv-nshvd.html

## 开发

### 开发环境

需要以下环境：

- nodejs 18+ with pnpm
- rust
- python3

需要以下依赖：

- [upx](https://github.com/upx/upx)：添加到环境变量

环境变量中的 python 命令应指向 python3。

### 安装依赖

只需手动安装前端依赖：

```bash
pnpm i
```

### 运行

执行运行命令后会自动安装 rust 依赖：

```bash
pnpm dev
```

### 开发

前端用的 vite，本身支持热重载，无需多说。

后端的 tauri 也支持重载，但不是热重载，后端代码或引用的文件一旦更改，会自动编译并重新启动。

需要注意的是，开发时尽量不要用`cargo update`更新 rust 依赖，有些依赖在跨版本后会出现不兼容或冲突的情况。

## 原理

### 尺寸转换

pdf 单元尺寸是 $1/72\ inch$ 或 $0.35\ mm$，需要根据此单元计算坐标或尺寸。

如 letter 的尺寸为 $8.5\ inch \times 11\ inch$，换算成 pdf 单元为 (612.0, 792.0)。

本程序默认采用 A4 尺寸($210\ mm \times 297\ mm$)，换算成 pdf 单元为 (595.2756, 841.8898)，有的 pdf 编辑软件会将此尺寸四舍五入设置为 (595, 842)，损失的像素精度已不是肉眼可见，但四舍五入也没什么意义。

## 决择

### 1 缩略图的生成

当前使用的方案是生成全部缩略图后通过数组返回给前端，但这会造成一定时间的等待。

另一种方案是通过事件监听，后端处理完一张缩略图便通过`emit`通知前端：

```rust
use tauri::event::{Event, emit};

fn sample() -> Result<(), String> {
    for i in items {
        emit("sample", i).map_err(|e| e.to_string())?;
    }
    
    Ok(())
}
```

前端就渲染一张缩略图：

```tsx
import { appWindow } from '@tauri-apps/api/window'

const ImageList: React.FC = () => {
  // ...
  useEffect(() => {
    void appWindow.listen<string[]>('sample', async (item) => {
      // 处理 item
    })
  })
}
```

这样前端页面的等待时间就大大缩短，甚至用户都看到不等待动画，这种方案的问题在于当缩略图未全部生成时用户的任何操作都应是无效操作，所以暂时未采用此方案。

## 功能列表

已实现和未实现的功能或特性如下：

- [x] 多张图片原图合并为 PDF
- [x] 拖拽选择图片
  - [x] 拖拽时根据文件名排序
- [ ] 手动排序
  - [ ] 添加一个排序按钮，将当前图片列表以文件名排序，点击一次从小到大，再点一次从大到小
- [x] 即时缩略图：每次选择图片都会生成一个缩略图，以 base64 的形式呈现缩略图
- [x] 响应式布局，根据窗口宽度自动调整每行数量
- [x] 图片预览
- [ ] 添加全局设置按钮，允许使用一些全局设置
  - [ ] 本地缓存
    - [ ] 缓存缩略图：开启此项时会将缩略图保存到本地，会占用一部分磁盘空间，但对重复图片不会重新生成缩略图，当你经常使用相同的图片生成 PDF 时开启此项能提高导出效率。
    - [ ] 缓存图片对象：开启此项时会将转换后的图片对象保存到本地，会占用一部分磁盘空间，但对重复图片不会重新生成 PDF 图片对象，当你经常使用相同的图片生成 PDF 时开启此项能提向导出效率。
  - [ ] 启用自动更新：开启此项后在以后的每次启动程序时会检查更新，如果有新版本会自动更新。
    - [ ] 更新镜像：因为 github 在国内访问有问题，可以采用自定义镜像的方式（如 ghproxy.com）加速。
  - [ ] 自动切换黑色模式
  - [ ] 全局图像设置
    - [ ] 图像压缩：对一些体积太大，但导出到 PDF 后又不需要太高清晰度的图片进行压缩可大幅减小 PDF 体积。
      - [ ] 最大图片体积：将所有超过最大图片体积的图片压缩到最大图片体积或近似大小。
      - [ ] 固定压缩比例：开启此项后对所有超过最大图片体积的图片进行同比例压缩。
- [ ] 图像旋转（左右 90 度）
- [ ] 图像翻转（水平、垂直）
- [ ] 单个图像设置
  - [ ] 图像压缩（二选一）：对一些体积太大，但导出到 PDF 后又不需要太高清晰度的图片进行压缩可大幅减小 PDF 体积。
    - [ ] 目标体积：将此图片的体积压缩到目标体积或近似大小。
    - [ ] 压缩比例：将此图片按指定比例压缩。
- [ ] 一些与 PDF 有关的其他实用功能

## 需要的支持

1. 上述功能列表中未实现的功能有很多，希望有兴趣的朋友能够帮忙添加一些功能。
2. 当前图标是我使用的开源图标站中的一个 PDF 文件图标，希望有设计能力的朋友能帮忙设计一款美观的图标。
3. 前端页面当前使用的是 antd 的默认风格，需要有经验的设计师帮忙重新设计一下。
4. 我自己使用时很难遇到没修复的 bug，希望在使用过程中遇到 bug 的朋友提 issue。

## 致谢

感谢：

- [vite](https://github.com/vitejs/vite)，是前端使用的构建工具。
- [react](https://github.com/facebook/react)，是构建前端界面的 JavaScript 库。
- [antd](https://github.com/ant-design/ant-design)，是构建前端界面的 React 组件库。
- [tauri](https://github.com/tauri-apps/tauri)，是用于构建跨平台原生应用程序的工具包。
- [lopdf](https://github.com/J-F-Liu/lopdf)，是 PDF 处理的核心库，由国人开发。

## License

OldDriver 项目基于 **MIT 协议**，请自由地享受和参与开源。
